# Malware RE note

## Algorithms 
### Encryption
### RC4

It is a small algorithm, composed of 3 main parts: 
- The key-scheduling algorithm (initialization stage); 
- the pseudo-random generation stage (scrambling stage);
- the XOR stage.

The initialization stage will simply create what is known as a substitution box, a table of values from 0x00 to 0xFF , which has a size of 256 bytes ( 0x100 ).
One of the giveaways RC4 is **the usage of 0x100 in 2 loops**

### AES

Search for Sbox or T tables :
https://android.googlesource.com/platform/external/openssh/+/idea133/rijndael.c

### Blowfish

Check perm :
https://github.com/B-Con/crypto-algorithms/blob/master/blowfish.c

## Magic numbers to know

### PE magic number
**4D 5A** -> MZ

### Start of function/code section

**55 8B EC**

```
55      push EBP
8B EC   mov ebp, esp
```

### Direct Syscall 64 bits 

**4C 8B D1 B8 xx 00 00 00 0F 05 C3**

```
0x4c 0x8b 0xd1      mov r10, rcx  
0xb8 xx 00 00 00    mov eax, xxh //xx is the specific value for the function to call 
0x0f 0x05           syscall 
0xc3                retn 
```


### Direct Syscall 32 bits 

**B8 xx 00 00 00 33 C9 8D 54 24 04 64 FF 15 C0 00 00 00**

```
0xb8 0xXX 0x00 0x00 0x00                   mov eax, XXh                          
0x33 0xc9                                  xor ecx,ecx                              
0x8d 0x54 0x24 04                          lea edx,dword ptr ss:[esp+4]            
0x64 0xff 0x15 0xC0 0x00 0x00 0x00         call dword ptr fs:[C0]          
```

## Useful breakpoint for unpacking

VirtualAlloc
VirtualProtect
WriteProcessMemory
NtWriteVirtualMemory
NtResumeThread
ResumeThread
CreateProcessInternalW
CreateProcessA
CreateProcessW
CreateRemoteThread
GetProcAddress
GetModuleHandleA 

## Reminder on function parameters in the stack

For instance for `WriteProcessMemory(hProcess, lpBaseAddress, lpBuffer, nSize, *lpNumberOfBytesWritten);`

Push the parameters from the end to the start. By doing that, the first function parameter (`hProcess`) is at the top of the stack. 
Yes yes, remember the stack is a LIFO = **LAST** in **FIRST** out.

Example : 

````
push *lpNumberOfBytesWritten
push nSize
push lpBuffer
push lpBaseAddress
push hProcess
```

State in the stack before the call

```
------------
hProcess 	<- ESP
------------
lpBaseAddress
------------
lpBuffer
------------
nSize
------------
*lpNumberOfBytesWritten
```
